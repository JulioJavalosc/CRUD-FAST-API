{% extends "front/base.html" %}
{% block title %}Registrar Venta{% endblock %}

{% block content %}
<div class="container-fluid">
    <h1 class="h3 mb-4 text-gray-800">Registrar Nueva Venta</h1>
    <div class="mt-3 text-end">
        
    </div>


    <form id="formVenta" method="post" action="/ventas/guardar">
        <h4>Total General: <span id="totalGeneral">$0.00</span></h4>
        <input type="hidden" name="total_general" id="total_general_input" value="">
        <input type="hidden" name="Usuarios_id" value="{{ user.id }}">
        <div class="mb-3">
            <label for="cliente" class="form-label">Cliente</label>
            <select name="Clientes_id" id="cliente" class="form-select" required>
                {% for cliente in clientes %}
                <option value="{{ cliente.id }}">{{ cliente.Nombre }} {{cliente.Apellido}}</option>
                {% endfor %}
            </select>
            <button type="button" class="btn btn-success" data-toggle="modal" data-target="#nuevoClienteModal"
                title="Agregar nuevo cliente">
                <i class="bi bi-plus"></i>
            </button>
        </div>

        <div class="mb-3">
            <label for="producto" class="form-label">Producto Fijo</label>
            <div class="input-group">
                <select name="idProductoSelect" id="productoSelect" class="form-select" required>
                    {% for p in productos %}
                    <option value="{{ p.idProducto }}" data-precio="{{ p.Precio }}" data-nombre="{{ p.Descripcion }}"
                        data-stock="{{p.Stock}}">
                        {{ p.Descripcion }} - ${{ p.Precio }}
                    </option>
                    {% endfor %}
                </select>
                <div class="input-group-append">
                    <button type="button" class="btn btn-info" id="agregarProducto">Agregar a la tabla</button>

                </div>
            </div>
        </div>

        <table class="table table-bordered" id="tablaProductos">
            <thead>
                <tr>
                    <th>Producto</th>
                    <th>Precio Unitario</th>
                    <th>Cantidad</th>
                    <th>Subtotal</th>
                    <th>Acciones</th>
                </tr>
            </thead>
            <tbody></tbody>
            <tfoot>
                <tr>
                    <td colspan="3" class="text-right"><strong>Total</strong></td>
                    <td colspan="2" id="totalProductos">$0.00</td>
                </tr>
            </tfoot>
        </table>
        <h4>Helados Personalizados</h4>
        <button type="button" class="btn btn-outline-success mb-3" data-toggle="modal" data-target="#heladoModal">
            <i class="bi bi-iceberg"></i>Agregar
        </button>
        <table class="table table-bordered" id="tablaHelados">
            <thead>
                <tr>
                    <th>Helado</th>
                    <th>Precio Unitario</th>
                    <th>Cantidad</th>
                    <th>Subtotal</th>
                    <th>Acciones</th>
                </tr>
            </thead>
            <tbody></tbody>
            <tfoot>
                <tr>
                    <td colspan="3" class="text-end"><strong>Total</strong></td>
                    <td id="totalHelados">$0.00</td>
                    <td></td>
                </tr>
            </tfoot>
        </table>
        <button type="submit" class="btn btn-primary">Registrar Venta</button>
          <input type="hidden" name="helados_json" id="helados_json" value="">
    </form>

</div>



<!-- Modal para armar helado personalizado -->
<div class="modal fade" id="heladoModal" tabindex="-1" aria-labelledby="heladoModalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="heladoModalLabel">Armar Helado Personalizado</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Cerrar"></button>
            </div>
            <div class="modal-body">
                <div class="mb-3">
                    <label class="form-label">Agregar Sabores</label>
                    <div id="sabores-container">
                        <!-- Campo inicial -->
                        <div class="input-group mb-2">
                            <select name="id_Sabor[]" class="form-select sabor-select" required>
                                {% for sabor in sabores %}
                                <option value="{{ sabor.id_Sabor }}" data-nombre="{{ sabor.Nombre }}"
                                    data-precio="{{ sabor.Precio }}">
                                    {{ sabor.Nombre }} - ${{ sabor.Precio }}
                                </option>
                                {% endfor %}
                            </select>
                            <input type="number" name="Cantidad_Bolas[]" class="form-control bolas-input"
                                placeholder="Bolas" min="1" required />
                            <button type="button" class="btn btn-danger ms-1"
                                onclick="this.closest('.input-group').remove()">
                                <i class="bi bi-trash"></i>
                            </button>
                        </div>
                    </div>
                    <button type="button" class="btn btn-sm btn-outline-secondary mt-2" onclick="agregarSabor()">+
                        Agregar otro sabor</button>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
                <button type="button" class="btn btn-success" onclick="guardarHelado()">Guardar Helado</button>
            </div>
        </div>
    </div>
</div>

<div class="modal fade" id="nuevoClienteModal" tabindex="-1" role="dialog" aria-labelledby="nuevoClienteLabel"
    aria-hidden="true">
    <div class="modal-dialog" role="document">
        <div class="modal-content">
            <form  method="post" action="/clientes/guardar">

                <div class="modal-header">
                    <h5 class="modal-title" id="nuevoClienteLabel">Registrar Nuevo Cliente</h5>
                    <button type="button" class="close" data-dismiss="modal" aria-label="Cerrar">
                        <span aria-hidden="true">&times;</span>
                    </button>
                </div>
                <div class="modal-body">
                    <div class="form-group">
                        <label for="nombreCliente">Nombre</label>
                        <input type="text" class="form-control" id="nombreCliente" name="Nombre">
                        <label for="apellidoCliente">Apellido</label>
                        <input type="text" class="form-control" id="apellidoCliente" name="apellido">
                        <label for="telefonoCliente">Telefono</label>
                        <input type="text" class="form-control" id="telefonoCliente" name="telefono">
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="submit" class="btn btn-primary">Guardar</button>
                    <button type="button" class="btn btn-secondary" data-dismiss="modal">Cancelar</button>
                </div>
            
          
            </form>
        </div>
    </div>
</div>
<script>
    //Clientes
    document.addEventListener("DOMContentLoaded", function () {


        document.getElementById("formVenta").addEventListener("submit", function (e) {
        console.log('Submit detectado');   
        window.alert('¡Formulario enviado!');
        prepararDatosHelados();
        console.log('Datos helados:', document.getElementById("helados_json").value);
        });
        const formCliente = document.querySelector("#nuevoClienteModal form");

        if (formCliente) {
            formCliente.addEventListener("submit", async function (e) {
                e.preventDefault();

                const formData = new FormData(formCliente);
                const response = await fetch("/clientes/guardar-ajax", {
                    method: "POST",
                    body: formData
                });

                if (!response.ok) {
                    alert("Error en la solicitud");
                    return;
                }

                const result = await response.json();

                if (result && result.id) {
                    const clienteSelect = document.getElementById("cliente");
                    const option = document.createElement("option");
                    option.value = result.id;
                    option.textContent = result.Nombre;

                    // Agregar opción y seleccionarla
                    clienteSelect.appendChild(option);
                    clienteSelect.value = result.id;

                    // Cerrar el modal
                    const modalElement = document.getElementById('nuevoClienteModal');
                    const modal = bootstrap.Modal.getInstance(modalElement);
                    if (modal) modal.hide();
                } else {
                    alert("Hubo un problema al registrar el cliente");
                }
            });
        }
    });

    //Productos

    document.addEventListener("DOMContentLoaded", function () {
        const tabla = document.querySelector("#tablaProductos tbody");
        const agregarBtn = document.getElementById("agregarProducto");
        const productoSelect = document.getElementById("productoSelect");
        const totalDisplay = document.getElementById("totalGeneral");

        function actualizarTotal() {
            let total = 0;
            tabla.querySelectorAll("tr").forEach(row => {
                const subtotal = parseFloat(row.querySelector(".subtotal").textContent.replace("$", ""));
                total += subtotal;
            });
            totalDisplay.textContent = `$${total.toFixed(2)}`;
        }


        function crearFilaProducto(nombre, precio, idProducto, stockDisponible) {
            const fila = document.createElement("tr");

            fila.innerHTML = `
        
            <td>${nombre}<input type="hidden" name="idProducto" value="${idProducto}"></td>
        <td>$${precio.toFixed(2)}</td>
        <td>
            <input type="number" name="Cantidad" class="form-control cantidad-input" value="1" min="1" max="${stockDisponible}" style="width: 80px;">
            <small class="text-muted">Máx: ${stockDisponible}</small>
        </td>
        <td class="subtotal">$${precio.toFixed(2)}</td>
        <td>
            <button type="button" class="btn btn-danger btn-sm eliminar">Eliminar</button>
        </td>
    `;

            const cantidadInput = fila.querySelector(".cantidad-input");

            // Validación al cambiar cantidad
            cantidadInput.addEventListener("input", function () {
                let cantidad = parseInt(this.value);

                if (cantidad > stockDisponible) {
                    alert(`No hay suficiente stock. Solo hay ${stockDisponible} unidades disponibles.`);
                    this.value = stockDisponible;
                    cantidad = stockDisponible;
                } else if (cantidad < 1) {
                    this.value = 1;
                    cantidad = 1;
                }

                const nuevoSubtotal = cantidad * precio;
                fila.querySelector(".subtotal").textContent = `$${nuevoSubtotal.toFixed(2)}`;
                actualizarTotales();
            });

            fila.querySelector(".eliminar").addEventListener("click", function () {
                fila.remove();
                actualizarTotales();
            });

            tabla.appendChild(fila);
            actualizarTotales();
        }


        agregarBtn.addEventListener("click", function () {
            const opcionSeleccionada = productoSelect.options[productoSelect.selectedIndex];
            const nombre = opcionSeleccionada.getAttribute("data-nombre");
            const precio = parseFloat(opcionSeleccionada.getAttribute("data-precio"));
            const stock = parseInt(opcionSeleccionada.getAttribute("data-stock"));
            const idProducto = opcionSeleccionada.value;

            crearFilaProducto(nombre, precio, idProducto, stock);
        });
    });

    //Helados

    function agregarSabor() {
        const container = document.getElementById("sabores-container");

        const div = document.createElement("div");
        div.className = "input-group mb-2";
        div.innerHTML = `
        <select name="id_Sabor[]" class="form-select sabor-select" required>
            {% for sabor in sabores %}
                <option value="{{ sabor.id_Sabor }}" data-nombre="{{ sabor.Nombre }}" data-precio="{{ sabor.Precio }}">
                    {{ sabor.Nombre }} - {{ sabor.Precio }}
                </option>
            {% endfor %}
        </select>
        <input type="number" name="Cantidad_Bolas[]" class="form-control bolas-input" placeholder="Bolas" min="1" required />
        <button type="button" class="btn btn-danger ms-1" onclick="this.closest('.input-group').remove()">
            <i class="bi bi-trash"></i>
        </button>
    `;
        container.appendChild(div);
    }
    function guardarHelado() {
        const saboreslist = document.querySelectorAll("#sabores-container .input-group");
        let nombreHelado = "";
        let precioTotal = 0;
        const saboresData = [];
        // Recorrer sabores seleccionados
        saboreslist.forEach(grupo => {
            const select = grupo.querySelector(".sabor-select");
            const inputBolas = grupo.querySelector(".bolas-input");
            const saborId = select.value
            const selectedOption = select.options[select.selectedIndex];
            const nombreSabor = selectedOption.getAttribute("data-nombre");
            const precioSabor = parseFloat(selectedOption.getAttribute("data-precio"));
            const bolas = parseInt(inputBolas.value || 1);
            saboresData.push({ id: saborId, nombre: nombreSabor, bolas: bolas });
            if (!nombreSabor || isNaN(precioSabor) || isNaN(bolas)) return;

            const subtotal = precioSabor * bolas;
            nombreHelado += `${nombreSabor} (${bolas}), `;
            precioTotal += subtotal;
        });

        // Limpiar modal después de guardar
        document.getElementById("sabores-container").innerHTML = `
        <div class="input-group mb-2">
            <select name="id_Sabor[]" class="form-select sabor-select" required>
                {% for sabor in sabores %}
                    <option value="{{ sabor.id_Sabor }}" data-nombre="{{ sabor.Nombre }}" data-precio="{{ sabor.Precio }}">
                        {{ sabor.Nombre }} - {{ sabor.Precio }}
                    </option>
                {% endfor %}
            </select>
            <input type="number" name="Cantidad_Bolas[]" class="form-control bolas-input" placeholder="Bolas" min="1" required />
            <button type="button" class="btn btn-danger ms-1" onclick="this.closest('.input-group').remove()">
                <i class="bi bi-trash"></i>
            </button>
        </div>
    `;

        // Agregar a tabla de helados
        const tablaHelados = document.querySelector("#tablaHelados tbody");

        const fila = document.createElement("tr");
        fila.dataset.sabores = JSON.stringify(saboresData);
        fila.innerHTML = `
        <td>${nombreHelado}</td>
        <td>$${precioTotal.toFixed(2)}</td>
        <td><input type="number" class="form-control cantidad-helado" name="CantidadHelado" value="1" min="1" style="width: 80px;"></td>
        <td class="subtotal-helado">$${precioTotal.toFixed(2)}</td>
        <td><button type="button" class="btn btn-danger btn-sm" onclick="this.closest('tr').remove(); actualizarTotales();">Eliminar</button></td>
    `;

        tablaHelados.appendChild(fila);
        actualizarTotales();
        // Evento para cantidad
        fila.querySelector(".cantidad-helado").addEventListener("input", function () {
            const cantidad = parseInt(this.value) || 1;
            const nuevoSubtotal = precioTotal * cantidad;
            fila.querySelector(".subtotal-helado").textContent = `$${nuevoSubtotal.toFixed(2)}`;
            actualizarTotales();
        });

        const heladosContainer = document.getElementById("heladosInputsContainer");
        const heladoIndex = document.querySelectorAll("#heladosInputsContainer .helado-bloque").length;

        const sabores = document.querySelectorAll("#sabores-container .input-group");

        // Crear bloque de inputs para este helado
        const heladoBlock = document.createElement("div");
        heladoBlock.classList.add("helado-bloque");

        sabores.forEach((grupo, i) => {
            const select = grupo.querySelector(".sabor-select");
            const bolas = grupo.querySelector(".bolas-input").value;
            const saborId = select.value;

            // Agregar input oculto por sabor
            heladoBlock.innerHTML += `
        <input type="hidden" name="helados[${heladoIndex}][sabores][${i}][id_Sabor]" value="${saborId}">
        <input type="hidden" name="helados[${heladoIndex}][sabores][${i}][Cantidad_Bolas]" value="${bolas}">
    `;
        });

        // Agregar cantidad del helado (cantidad de veces que se repite esa combinación)
        const cantidadHelado = fila.querySelector(".cantidad-helado").value;
        heladoBlock.innerHTML += `
    <input type="hidden" name="helados[${heladoIndex}][cantidad]" value="${cantidadHelado}">
`;

        // Agregar precio total
        heladoBlock.innerHTML += `
    <input type="hidden" name="helados[${heladoIndex}][precio]" value="${precioTotal}">
`;

        heladosContainer.appendChild(heladoBlock);
        // Cerrar modal
        bootstrap.Modal.getInstance(document.getElementById("heladoModal")).hide();

        // Actualizar total general
        setTimeout(actualizarTotales, 100);
    }
    function actualizarTotales() {
        let totalProductos = 0;
        let totalHelados = 0;
        // Sumar productos fijos
        document.querySelectorAll("#tablaProductos .subtotal").forEach(td => {
            const valor = parseFloat(td.textContent.replace("$", ""));
            if (!isNaN(valor)) totalProductos += valor;
        });

        // Sumar helados personalizados
        document.querySelectorAll("#tablaHelados .subtotal-helado").forEach(td => {
            const valor = parseFloat(td.textContent.replace("$", ""));
            if (!isNaN(valor)) totalHelados += valor;
        });

        // Actualizar display por tabla
        document.getElementById("totalProductos").textContent = `$${totalProductos.toFixed(2)}`;
        document.getElementById("totalHelados").textContent = `$${totalHelados.toFixed(2)}`;

        // Calcular total general
        const totalVenta = totalProductos + totalHelados;
        document.getElementById("totalGeneral").textContent = `$${totalVenta.toFixed(2)}`;

        // Actualiza el input hidden
    document.getElementById("total_general_input").value = totalVenta.toFixed(2);
    }

    // Llama esta función cada vez que agregas un sabor
    document.getElementById("agregarSaborBtn").addEventListener("click", function () {
        agregarSabor();
        setTimeout(actualizarSaboresDisponibles, 50);  // Esperar a que DOM actualice
    });

    // También llama cuando cambias un select
    document.addEventListener("change", function (e) {
        if (e.target && e.target.classList.contains("sabor-select")) {
            actualizarSaboresDisponibles();
        }
    });
    //Carga de Datos a venta
    function recolectarDetalles() {
        const detalles = [];
        // Recorrer productos fijos
        document.querySelectorAll("#tablaProductos tbody tr").forEach(row => {
            const nombre = row.cells[0].textContent;
            const precio = parseFloat(row.cells[1].textContent.replace("$", ""));
            const cantidad = parseInt(row.querySelector(".cantidad-input").value);
            const subtotal = precio * cantidad;

            detalles.push({
                tipo: "producto",
                id: row.querySelector("[name='idProducto']").value,
                nombre,
                precio,
                cantidad,
                subtotal
            });
        });
        // Recorrer helados personalizados

        
    }
    function prepararDatosHelados() {
            const helados = [];

            document.querySelectorAll("#tablaHelados tbody tr").forEach((row) => {
                const sabores = JSON.parse(row.dataset.sabores || "[]");
                console.log(sabores);
                const cantidad = parseInt(row.querySelector(".cantidad-helado").value) || 1;
                const precio = parseFloat(row.cells[1].textContent.replace("$", ""));

                helados.push({
                    sabores,
                    cantidad,
                    precio
                });
            });
            console.log(helados);
            document.getElementById("helados_json").value = JSON.stringify(helados);
        }
     

</script>
{% endblock %}